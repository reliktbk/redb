# проект redb

## 1. Общая структура проекта
```
redb/
│
├── redb.Core/
│   ├── redb.Core.MSSql/
│   ├── redb.Core.Postgres/
│   ├── redb.Core.SQLite/
│   ├── redb.Core/
│
├── redb.WebApp/
│
├── .dockerignore
├── .gitattributes
├── .gitignore
├── README.md
└── redb.sln
```

## 2. Компоненты проекта
### 2.1 redb.Core
Основной модуль системы, который включает:

- **redb.Core.MSSql**: Работа с Microsoft SQL Server.
- **redb.Core.Postgres**: Работа с PostgreSQL.
- **redb.Core.SQLite**: Работа с SQLite.
- **redb.Core**: Общая логика и функциональность.

### 2.2 redb.WebApp
Модуль, предоставляющий веб-интерфейс и взаимодействующий с пользователями.

## 3. Архитектура
### 3.1 Модели (Models)
Определяют структуру данных и используемые свойства для взаимодействия с базой данных.

### 3.2 Контекст базы данных (DbContext)
Управляет состоянием сущностей и их взаимодействием с базой данных, определяет DbSet для различных моделей.

### 3.3 Службы (Services)
Содержат бизнес-логику и обработку запросов. Интерфейсы и их реализации разделяют уровни приложения.

### 3.4 Контроллеры (Controllers)
Обрабатывают HTTP-запросы, связь между моделями и представлениями, а также управление пользовательским интерфейсом.

## 4. Технологии и паттерны
- **Entity Framework Core**: ORM для работы с базами данных.
- **Dependency Injection (DI)**: Применяется для управления зависимостями.
- **ASP.NET MVC**: Архитектурный паттерн для веб-приложений.
- **Docker**: Контейнеризация для упрощения развертывания.

## 5. Индексация и производительность
Индексы создаются для повышения производительности запросов на важные для анализа и выборки столбцы.

## 6. Триггеры и функции
Используются для автоматизации действий на уровне базы данных, таких как архивирование данных при их удалении.

## 7. Инициализация базы данных
Содержит команды для создания и заполнения таблиц начальными данными, а также для обеспечения структур integrity.

## 8. Заключение
Проект redb представляет собой хорошо структурированную, кросс-платформенную и масштабируемую систему управления базами данных с современными технологиями и архитектурой, что обеспечивает эффективность и простоту использования. 
 # SQL схемы базы данных   
[redb Postgre sql code](https://github.com/reliktbk/redb/blob/master/redb.Core.Postgres/sql/redbPostgre.sql)

[redb MSSQL sql code](https://github.com/reliktbk/redb/blob/master/redb.Core.MSSql/sql/redbMSSQL.sql)

[redb sqlite sql code](https://github.com/reliktbk/redb/blob/master/redb.Core.SQLite/sql/redbsqlite.sql)



---


## Введение
Данный SQL-скрипт выполняет следующие основные операции:
1. Удаление последовательности и таблиц.
2. Создание новых таблиц для хранения данных о типах, ссылках, списках, ролях, пользователях, структурах, объектах, функциях и других связанных данных.
3. Создание триггерной функции и триггера для архивирования удаленных объектов.
4. Инициализация начальных значений для некоторых таблиц.

## Удаление существующих объектов

### Удаление последовательности
Удаляет последовательность `global_identity`, если она существует.

### Удаление таблиц
Удаляет указанные таблицы, если они существуют:
- `_deleted_objects`
- `_dependencies`
- `_values`
- `_permissions`
- `_structures`
- `_users_roles`
- `_roles`
- `_list_items`
- `_lists`
- `_objects`
- `_links`
- `_users`
- `_functions`
- `_schemes`
- `_types`

## Создание таблиц

### 1. `_types`
Таблица для хранения типов данных.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор типа.
  - `_name` (varchar(250)): Наименование типа.
  - `_db_type` (varchar(250)): Тип данных в базе данных.
  - `_type` (varchar(250)): Тип данных в приложении.
- **Ограничения**:
  - `PK__types`: Первичный ключ по столбцу `_id`.

### 2. `_links`
Таблица для хранения связей между объектами.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор связи.
  - `_id_1` (bigint): Идентификатор первого объекта.
  - `_id_2` (bigint): Идентификатор второго объекта.
- **Ограничения**:
  - `PK__links`: Первичный ключ по столбцу `_id`.
  - `IX__links`: Уникальное ограничение на пару (`_id_1`, `_id_2`).
  - `CK__links`: Проверка на то, что `_id_1` не равен `_id_2`.

### 3. `_lists`
Таблица для хранения списков.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор списка.
  - `_name` (varchar(250)): Наименование списка.
  - `_alias` (varchar(250)): Альтернативное имя списка.
- **Ограничения**:
  - `PK__lists`: Первичный ключ по столбцу `_id`.

### 4. `_roles`
Таблица для хранения ролей пользователей.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор роли.
  - `_name` (varchar(250)): Наименование роли.
- **Ограничения**:
  - `PK__roles`: Первичный ключ по столбцу `_id`.
  - `IX__roles`: Уникальное ограничение на столбец `_name`.

### 5. `_users`
Таблица для хранения информации о пользователях.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор пользователя.
  - `_login` (varchar(250)): Логин пользователя.
  - `_password` (TEXT): Пароль пользователя.
  - `_name` (varchar(250)): Имя пользователя.
  - `_phone` (varchar(250)): Номер телефона пользователя.
  - `_email` (varchar(250)): Email пользователя.
  - `_date_register` (timestamp): Дата регистрации пользователя.
  - `_date_dismiss` (timestamp): Дата увольнения пользователя.
  - `_enabled` (boolean): Признак активности пользователя.
- **Ограничения**:
  - `PK__users`: Первичный ключ по столбцу `_id`.

### 6. `_users_roles`
Таблица для связи пользователей и ролей.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор записи.
  - `_id_role` (bigint): Идентификатор роли.
  - `_id_user` (bigint): Идентификатор пользователя.
- **Ограничения**:
  - `PK__users_roles`: Первичный ключ по столбцу `_id`.
  - `IX__users_roles`: Уникальное ограничение на пару (`_id_role`, `_id_user`).
  - `FK__users_roles__roles`: Ограничение внешнего ключа на таблицу `_roles`.
  - `FK__users_roles__users`: Ограничение внешнего ключа на таблицу `_users`.

### 7. `_schemes`
Таблица для хранения схем.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор схемы.
  - `_id_parent` (bigint): Идентификатор родительской схемы.
  - `_name` (varchar(250)): Наименование схемы.
  - `_alias` (varchar(250)): Альтернативное имя схемы.
  - `_name_space` (varchar(1000)): Пространство имен схемы.
- **Ограничения**:
  - `PK__schemes`: Первичный ключ по столбцу `_id`.
  - `IX__schemes`: Уникальное ограничение на столбец `_name`.
  - `FK__schemes__schemes`: Ограничение внешнего ключа на таблицу `_schemes`.

### 8. `_structures`
Таблица для хранения структур данных.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор структуры.
  - `_id_parent` (bigint): Идентификатор родительской структуры.
  - `_id_scheme` (bigint): Идентификатор схемы.
  - `_id_override` (bigint): Идентификатор перекрывающей структуры.
  - `_id_type` (bigint): Идентификатор типа данных.
  - `_id_list` (bigint): Идентификатор списка.
  - `_name` (varchar(250)): Наименование структуры.
  - `_alias` (varchar(250)): Альтернативное имя структуры.
  - `_order` (bigint): Порядок отображения.
  - `_readonly` (boolean): Признак только для чтения.
  - `_allow_not_null` (boolean): Признак разрешения null-значений.
  - `_is_array` (boolean): Признак массива.
  - `_is_compress` (boolean): Признак сжатия.
  - `_store_null` (boolean): Признак хранения null-значений.
  - `_default_value` (bytea): Значение по умолчанию.
  - `_default_editor` (text): Редактор по умолчанию.
- **Ограничения**:
  - `PK__structure`: Первичный ключ по столбцу `_id`.
  - `IX__structures`: Уникальное ограничение на пару (`_id_scheme`, `_name`).
  - `FK__structures__structures`: Ограничение внешнего ключа на таблицу `_structures`.
  - `FK__structures__schemes`: Ограничение внешнего ключа на таблицу `_schemes`.
  - `FK__structures__types`: Ограничение внешнего ключа на таблицу `_types`.
  - `FK__structures__lists`: Ограничение внешнего ключа на таблицу `_lists`.

### 9. `_dependencies`
Таблица для хранения зависимостей между схемами.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор зависимости.
  - `_id_scheme_1` (bigint): Идентификатор первой схемы.
  - `_id_scheme_2` (bigint): Идентификатор второй схемы.
- **Ограничения**:
  - `PK__dependencies`: Первичный ключ по столбцу `_id`.
  - `IX__dependencies`: Уникальное ограничение на пару (`_id_scheme_1`, `_id_scheme_2`).
  - `FK__dependencies__schemes_1`: Ограничение внешнего ключа на таблицу `_schemes`.
  - `FK__dependencies__schemes_2`: Ограничение внешнего ключа на таблицу `_schemes`.

### 10. `_objects`
Таблица для хранения объектов.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор объекта.
  - `_id_parent` (bigint): Идентификатор родительского объекта.
  - `_id_scheme` (bigint): Идентификатор схемы.
  - `_id_owner` (bigint): Идентификатор владельца объекта.
  - `_id_who_change` (bigint): Идентификатор пользователя, который изменил объект.
  - `_date_create` (timestamp): Дата создания объекта.
  - `_date_modify` (timestamp): Дата последнего изменения объекта.
  - `_date_begin` (timestamp): Дата начала действия объекта.
  - `_date_complete` (timestamp): Дата завершения действия объекта.
  - `_key` (bigint): Ключ объекта.
  - `_code_int` (bigint): Код объекта в виде целого числа.
  - `_code_string` (varchar(250)): Код объекта в виде строки.
  - `_code_guid` (uuid): Код объекта в виде GUID.
  - `_name` (varchar(250)): Наименование объекта.
  - `_note` (varchar(1000)): Примечание к объекту.
  - `_hash` (bytea): Хэш объекта.
- **Ограничения**:
  - `PK__objects`: Первичный ключ по столбцу `_id`.
  - `CK__hash`: Проверка на длину хэша (не более 32 байт).
  - `FK__objects__objects`: Ограничение внешнего ключа на таблицу `_objects`.
  - `FK__objects__schemes`: Ограничение внешнего ключа на таблицу `_schemes`.
  - `FK__objects__users1`: Ограничение внешнего ключа на таблицу `_users` для владельца объекта.
  - `FK__objects__users2`: Ограничение внешнего ключа на таблицу `_users` для пользователя, который изменил объект.

### 11. `_deleted_objects`
Таблица для хранения удаленных объектов.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор удаленного объекта.
  - `_id_parent` (bigint): Идентификатор родительского объекта.
  - `_id_scheme` (bigint): Идентификатор схемы.
  - `_id_owner` (bigint): Идентификатор владельца объекта.
  - `_id_who_change` (bigint): Идентификатор пользователя, который изменил объект.
  - `_date_create` (timestamp): Дата создания объекта.
  - `_date_modify` (timestamp): Дата последнего изменения объекта.
  - `_date_begin` (timestamp): Дата начала действия объекта.
  - `_date_complete` (timestamp): Дата завершения действия объекта.
  - `_key` (bigint): Ключ объекта.
  - `_code_int` (bigint): Код объекта в виде целого числа.
  - `_code_string` (varchar(250)): Код объекта в виде строки.
  - `_code_guid` (uuid): Код объекта в виде GUID.
  - `_name` (varchar(250)): Наименование объекта.
  - `_note` (varchar(1000)): Примечание к объекту.
  - `_hash` (bytea): Хэш объекта.
  - `_date_delete` (timestamp): Дата удаления объекта.
  - `_values` (bytea): Значения объекта.
- **Ограничения**:
  - `PK__deleted_objects`: Первичный ключ по столбцу `_id`.

### 12. `_list_items`
Таблица для хранения элементов списков.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор элемента.
  - `_id_list` (bigint): Идентификатор списка.
  - `_value` (varchar(250)): Значение элемента.
  - `_id_object` (bigint): Идентификатор объекта.
- **Ограничения**:
  - `PK__list_items`: Первичный ключ по столбцу `_id`.
  - `FK__list_items__id_list`: Ограничение внешнего ключа на таблицу `_lists`.
  - `FK__list_items__objects`: Ограничение внешнего ключа на таблицу `_objects`.

### 13. `_values`
Таблица для хранения значений структур данных.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор значения.
  - `_id_structure` (bigint): Идентификатор структуры.
  - `_id_object` (bigint): Идентификатор объекта.
  - `_String` (varchar(850)): Значение в виде строки.
  - `_Long` (bigint): Значение в виде целого числа.
  - `_Guid` (uuid): Значение в виде GUID.
  - `_Double` (float): Значение в виде вещественного числа.
  - `_DateTime` (timestamp): Значение в виде даты и времени.
  - `_Boolean` (boolean): Значение в виде логического значения.
  - `_ByteArray` (bytea): Значение в виде массива байтов.
  - `_Text` (text): Значение в виде текста.
- **Ограничения**:
  - `PK__values`: Первичный ключ по столбцу `_id`.
  - `FK__values__objects`: Ограничение внешнего ключа на таблицу `_objects`.
  - `FK__values__structures`: Ограничение внешнего ключа на таблицу `_structures`.
  - `IX__values_SO`: Уникальное ограничение на пару (`_id_structure`, `_id_object`).

### 14. `_permissions`
Таблица для хранения прав доступа.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор права.
  - `_id_role` (bigint): Идентификатор роли.
  - `_id_user` (bigint): Идентификатор пользователя.
  - `_id_ref` (bigint): Идентификатор ссылки.
  - `_select` (boolean): Разрешение на выборку.
  - `_insert` (boolean): Разрешение на вставку.
  - `_update` (boolean): Разрешение на обновление.
  - `_delete` (boolean): Разрешение на удаление.
- **Ограничения**:
  - `PK__object_permissions`: Первичный ключ по столбцу `_id`.
  - `CK__permissions_users_roles`: Проверка на то, что либо `_id_role` не null, либо `_id_user` не null.
  - `IX__permissions`: Уникальное ограничение на пару (`_id_role`, `_id_user`, `_id_ref`, `_select`, `_insert`, `_update`, `_delete`).
  - `FK__permissions__roles`: Ограничение внешнего ключа на таблицу `_roles`.
  - `FK__permissions__users`: Ограничение внешнего ключа на таблицу `_users`.

### 15. `_functions`
Таблица для хранения функций.

- **Столбцы**:
  - `_id` (bigint): Уникальный идентификатор функции.
  - `_id_scheme` (bigint): Идентификатор схемы.
  - `_language` (varchar(50)): Язык программирования.
  - `_name` (varchar(1000)): Наименование функции.
  - `_body` (text): Тело функции.
- **Ограничения**:
  - `PK__functions`: Первичный ключ по столбцу `_id`.
  - `IX__functions_scheme_name`: Уникальное ограничение на пару (`_id_scheme`, `_name`).
  - `FK__functions__schemes`: Ограничение внешнего ключа на таблицу `_schemes`.

## Индексы

Создаются индексы для повышения производительности запросов на различные столбцы таблиц. Например:
- `IX__functions__schemes` на столбце `_id_scheme` таблицы `_functions`.
- `IX__permissions__roles` на столбце `_id_role` таблицы `_permissions`.
- `IX__permissions__users` на столбце `_id_user` таблицы `_permissions`.
- `IX__values__objects` на столбце `_id_object` таблицы `_values`.
- `IX__values__structures` на столбце `_id_structure` таблицы `_values`.
- `IX__values__String` на столбце `_String` таблицы `_values`.
- `IX__values__Long` на столбце `_Long` таблицы `_values`.
- `IX__values__Guid` на столбце `_Guid` таблицы `_values`.
- `IX__values__Double` на столбце `_Double` таблицы `_values`.
- `IX__values__DateTime` на столбце `_DateTime` таблицы `_values`.
- `IX__values__Boolean` на столбце `_Boolean` таблицы `_values`.
- `IX__list_items__id_list` на столбце `_id_list` таблицы `_list_items`.
- `IX__list_items__objects` на столбце `_id_object` таблицы `_list_items`.
- `IX__objects__objects` на столбце `_id_parent` таблицы `_objects`.
- `IX__objects__schemes` на столбце `_id_scheme` таблицы `_objects`.
- `IX__objects__users1` на столбце `_id_owner` таблицы `_objects`.
- `IX__objects__users2` на столбце `_id_who_change` таблицы `_objects`.
- `IX__objects__date_create` на столбце `_date_create` таблицы `_objects`.
- `IX__objects__date_modify` на столбце `_date_modify` таблицы `_objects`.
- `IX__objects__code_int` на столбце `_code_int` таблицы `_objects`.
- `IX__objects__code_string` на столбце `_code_string` таблицы `_objects`.
- `IX__objects__name` на столбце `_name` таблицы `_objects`.
- `IX__objects__code_guid` на столбце `_code_guid` таблицы `_objects`.
- `IX__objects__hash` на столбце `_hash` таблицы `_objects`.
- `IX__dependencies__schemes_1` на столбце `_id_scheme_1` таблицы `_dependencies`.
- `IX__dependencies__schemes_2` на столбце `_id_scheme_2` таблицы `_dependencies`.
- `IX__structures__structures` на столбце `_id_parent` таблицы `_structures`.
- `IX__structures__schemes` на столбце `_id_scheme` таблицы `_structures`.
- `IX__structures__types` на столбце `_id_type` таблицы `_structures`.
- `IX__structures__lists` на столбце `_id_list` таблицы `_structures`.
- `IX__schemes__schemes` на столбце `_id_parent` таблицы `_schemes`.
- `IX__users_roles__roles` на столбце `_id_role` таблицы `_users_roles`.
- `IX__users_roles__users` на столбце `_id_user` таблицы `_users_roles`.

## Триггерная функция и триггер

### Функция `public.ftr__objects__deleted_objects`

Эта функция выполняется перед удалением объекта из таблицы `_objects`. Она архивирует удаленный объект в таблицу `_deleted_objects`.

### Триггер `TR__objects__deleted_objects`

Этот триггер вызывает функцию `ftr__objects__deleted_objects` перед каждым удалением записи из таблицы `_objects`.

## Последовательность `global_identity`

Создается последовательность `global_identity` для генерации уникальных идентификаторов.

## Инициализация начальных значений для таблицы `_types`

В таблицу `_types` добавляются начальные значения для различных типов данных.

---

Описывает структуру базы данных, созданную данным SQL-скриптом, и объясняет назначение каждой таблицы, ее столбцов и ограничений.